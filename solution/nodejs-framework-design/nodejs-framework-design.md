## Node.js 框架设计

在开始之前，我们需要明确框架设计的目标。我们并不是想造一个底层框架，比如 koa、express 这种，一个原因是我们必须拥抱社区生态，新的轮子在生态方面可能会非常欠缺；另一方面，经过社区筛选后的成熟框架，肯定是更加合理的并且能够满足各种业务形态，新造的轮子可能会存在各种坑。因此我们这里所说的框架设计，是面向业务的，基于底层 Node.js 框架的；目标在于降低业务开发成本，约束代码风格，并提供性能分析、监控、上线部署、日志、单元测试等周边设施，最理想的情况是，业务同学只需要关注业务，其他方便面都交给框架来做。

### 业界框架

底层框架主要有：

- koa
- Express
- hapi
- restify
- fastify
- nest.js

这里所说的底层框架，肯定也是有响应的周边配套设施的，只是没有提供开箱即用的方式，也没有统一的规范，它们都可以通过简短的代码启动一个 http server。

上层框架：

- egg
- think.js
- midway
- meteor
- feathers.js

需要说明的是，上面只是对部分 Node.js 框架的简单划分，因为我并不熟悉所有框架，可能划分并不准确。

我们想要达到的目的，可能和 egg、think.js 比较接近，他们都基于约定的目录结构，有自己的开发规范，从而不同的开发人员写出来的代码都非常类似，易于维护；并且他们还提供了数据库连接、cookie、session、日志、多进程支持等特性。

### 设计思路

接下来，想一想，我们的框架要怎样设计呢？从我个人的角度来说，我比较想达到如下目标：

- 统一代码规范
- 框架概念少，易于上手，开发人员写着顺手，代码简洁
- 拥抱社区，社区工具不需要 Adapter 就能直接使用
- 提供周边工具

接下来我们一点点实现这些目标

#### 统一代码规范

对于统一代码规范，我们只需要约定目录结构，并对目录中导出的模块做一定要求就行了。对于常见的 Node.js http server，通常需要下面的目录：

```bash
├── router
│    └── index.js
├── middleware
│    └── index.js
├── controller
│    └── index.js
└── service
     └── index.js
```

router 目录用于定义路由，controller 目录用于定义路由 handle，service 目录用于抽象、复用 controller 逻辑。

除了上面的必要目录，还可以约定一些工具类目录，比如 config（项目配置）、timers（定时器）、utils（工具函数）等目录。

对于目录中的模块可以要求必须导出一个类、一个函数（用于后续自动加载约定目录中的模块）。

### 实现

### 链路追踪

### 内部 ts 实现与外部接口

### 周边工具

### 单元测试

### 升级维护